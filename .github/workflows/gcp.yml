name: Build and Deploy to GKE

on:
  push:
    branches: [ "homolog" ]

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GAR_LOCATION: us-central1 # TODO: update region of the Artifact Registry
  GKE_CLUSTER: cluster-1    # TODO: update to cluster name
  GKE_ZONE: us-central1-c   # TODO: update to cluster zone
  DEPLOYMENT_NAME: gke-test # TODO: update to deployment name
  REPOSITORY: samples # TODO: update to Artifact Registry docker repository
  IMAGE: static-site

jobs:
  deploy:
    name: Setup Gcloud Account
    runs-on: ubuntu-latest
    environment: gcp-homolog
    env:
      IMAGE_NAME: gcr.io/${{ secrets.GCP.PROJECT.ID }}/site:latest
      
    steps:
      # Git checkout 
    - name: Checkout
      uses: actions/checkout@v2

      # Login GCP
      uses: 'google-github-actions/setup-gcloud@v0.2.0'
      with:
        service_account_key: ${{secrets.GCP.CREDENTIALS}}
        project_id : ${{secrets.GCP.PROJECT.ID}}

    - name: Docker configuration
      run: gcloud auth configure-docker --quiet

    - name: Build docker image
      run: docker build -t $IMAGE_NAME

    - name: Push docker image
      run: docker push $IMAGE_NAME

    - name: Deploy docker image
      run: gcloud run deploy site --image $IMAGE_NAME --region us-central1 --memory 128Mi --min-instances 0 --max-instances 1 --plataform managed --port 80 --allow-unauthenticated 
      
      
